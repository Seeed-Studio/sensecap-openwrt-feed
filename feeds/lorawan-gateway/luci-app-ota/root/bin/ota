#!/bin/sh
# Simplified OTA script - direct download from fixed URL

if [ -f /lib/upgrade/ota.sh ]; then
    . /lib/upgrade/ota.sh
    export_ota_url
fi

if [ -z "$OTA_URL_BASE" ]; then
echo "Unsupported device." >&2
exit 255
fi

WRLOCK=/var/lock/ota_background.lock
STLOCK=/var/lock/ota_status.lock

action=${1}
shift

download() {
local url="$1"
exec 300>$STLOCK
flock 300
touch /tmp/firmware.img.tar.gz.part
echo >/tmp/firmware.img.tar.gz.progress
flock -u 300

local pid
echo "Downloading from $url" > /tmp/firmware.img.tar.gz.progress
flock 300
echo "#=#=#" >>/tmp/firmware.img.tar.gz.progress
curl -L --fail --show-error --connect-timeout 5 --progress-bar -o /tmp/firmware.img.tar.gz.part "$url" 2>>/tmp/firmware.img.tar.gz.progress &
pid="$!"
echo "$pid" > /var/run/ota/download.pid
flock -u 300

if wait $pid; then
rm -f /var/run/ota/download.pid
echo "Download completed" > /tmp/firmware.img.tar.gz.progress
flock 300
mv /tmp/firmware.img.tar.gz.part /tmp/firmware.img.tar.gz
rm -f /tmp/firmware.img.tar.gz.progress
flock -u 300
return 0
else
local ecode=$?
echo >>/tmp/firmware.img.tar.gz.progress
if [ $ecode -eq 143 ]; then
echo "Canceled!" >> /tmp/firmware.img.tar.gz.progress
else
echo "Download failed!" >> /tmp/firmware.img.tar.gz.progress
fi
flock 300
sed -i '/\r/d' /tmp/firmware.img.tar.gz.progress
flock -u 300
fi
rm -f /var/run/ota/download.pid
rm -f /tmp/firmware.img.tar.gz.part
return 1
}

lock_download() {
local lock="$WRLOCK"
exec 200>$lock
flock -n 200 || return
	local url="${1:-$OTA_URL_BASE}"
	download "$url"
flock -u 200
}

do_check() {
local ret=0
local lock="$WRLOCK"

# Force cleanup if there's any download process (dead or alive)
if [ -f /var/run/ota/download.pid ]; then
local old_pid=$(cat /var/run/ota/download.pid)
if kill -0 "$old_pid" 2>/dev/null; then
# Process still running, kill it
kill "$old_pid" 2>/dev/null
sleep 1
kill -9 "$old_pid" 2>/dev/null
fi
# Clean up files
rm -f /var/run/ota/download.pid
rm -f /tmp/firmware.img.tar.gz.part
rm -f /tmp/firmware.img.tar.gz.progress
fi

exec 200>$lock
if flock -n 200; then
mkdir -p /var/run/ota
echo "Ready to download firmware from:" > /var/run/ota/ota.log
echo "$OTA_URL_BASE" >> /var/run/ota/ota.log
ret=0
flock -u 200 >/dev/null 2>&1
elif [ -f /tmp/firmware.img.tar.gz.progress -o -f /tmp/firmware.img.tar.gz ]; then
ret=2
else
echo "lock failed!" >&2
return 255
fi

if [ "$ret" -eq 0 -o "$ret" -eq 2 ]; then
cat /var/run/ota/ota.log
fi
return $ret
}

do_download(){
lock_download "$@" &
return 0
}

do_progress() {
[ -f /tmp/firmware.img.tar.gz ] && [ ! -f /tmp/firmware.img.tar.gz.progress ] && return 0
[ -f /tmp/firmware.img.tar.gz.progress ] || { echo "download not in progress" >&2 ; return 254; }

if [ -f /tmp/firmware.img.tar.gz.part ]; then
# Extract percentage from curl progress bar
local progress=$(cat /tmp/firmware.img.tar.gz.progress | tr '\r' '\n' | tail -n1 | grep -o '[0-9]\+\.[0-9]\+%' | tail -1)
if [ -n "$progress" ]; then
echo "$progress"
return 1
else
echo "0%"
return 1
fi
fi

if ! [ -f /tmp/firmware.img.tar.gz ]; then
cat /tmp/firmware.img.tar.gz.progress >&2
return 2
fi

return 0
}

do_cancel() {
if [ -f /var/run/ota/download.pid ]; then
local pid=$(cat /var/run/ota/download.pid)
if kill -0 "$pid" 2>/dev/null; then
kill "$pid" 2>/dev/null
sleep 1
kill -9 "$pid" 2>/dev/null
fi
rm -f /var/run/ota/download.pid
fi

rm -f /tmp/firmware.img.tar.gz.part
rm -f /tmp/firmware.img.tar.gz
rm -f /tmp/firmware.img.tar.gz.progress

return 0
}

do_upgrade() {
if [ ! -f /tmp/firmware.img.tar.gz ]; then
echo "No firmware file found!" >&2
return 1
fi

echo "Extracting firmware..."
tar -xzf /tmp/firmware.img.tar.gz -C /

if [ $? -eq 0 ]; then
echo "Firmware extracted successfully. Rebooting..."
rm -f /tmp/firmware.img.tar.gz
sync
reboot
return 0
else
echo "Failed to extract firmware!" >&2
return 1
fi
}

case "$action" in
check)
do_check
;;
download)
do_download "$@"
;;
progress)
do_progress
;;
cancel)
do_cancel
;;
upgrade)
do_upgrade
;;
*)
echo "usage: $0 {check|download|progress|cancel|upgrade}" >&2
exit 1
;;
esac
