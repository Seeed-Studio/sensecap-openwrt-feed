From 835afdc8a7ebb6a328d253e87a95a01406b93a10 Mon Sep 17 00:00:00 2001
From: qian <ruiqian.tang@seeed.cc>
Date: Wed, 7 Jan 2026 10:31:41 +0800
Subject: [PATCH] add: implement whitelist functionality for packet filtering

---
 packet_forwarder/src/lora_pkt_fwd.c | 191 ++++++++++++++++++++++++++--
 1 file changed, 177 insertions(+), 14 deletions(-)

diff --git a/packet_forwarder/src/lora_pkt_fwd.c b/packet_forwarder/src/lora_pkt_fwd.c
index 46484be..16ba249 100644
--- a/packet_forwarder/src/lora_pkt_fwd.c
+++ b/packet_forwarder/src/lora_pkt_fwd.c
@@ -119,6 +119,19 @@ License: Revised BSD License, see LICENSE.TXT file include in the project
 #define DEFAULT_BEACON_POWER        14
 #define DEFAULT_BEACON_INFODESC     0
 
+#define WHITELIST_SIZE  16
+
+
+/* whitelists */
+static bool whitelist_enable= false;
+
+static uint8_t whitelist_netids_count = 0;
+static uint32_t whitelist_netids[WHITELIST_SIZE];
+static uint8_t whitelist_ouis_count = 0;
+static uint32_t whitelist_ouis[WHITELIST_SIZE];
+static uint32_t whitelist_devaddr_min = 0;
+static uint32_t whitelist_devaddr_max = 0;
+
 /* -------------------------------------------------------------------------- */
 /* --- PRIVATE TYPES -------------------------------------------------------- */
 
@@ -300,6 +313,8 @@ static void gps_process_coords(void);
 
 static int get_tx_gain_lut_index(uint8_t rf_chain, int8_t rf_power, uint8_t * lut_index);
 
+static uint32_t get_netid(uint32_t devaddr);
+
 /* threads */
 void thread_up(void);
 void thread_down(void);
@@ -1218,6 +1233,61 @@ static int parse_gateway_configuration(const char * conf_file) {
         MSG("INFO: Auto-quit after %u non-acknowledged PULL_DATA\n", autoquit_threshold);
     }
 
+    val = json_object_get_value(conf_obj, "whitelist_enable");
+    if (json_value_get_type(val) == JSONBoolean) {
+        whitelist_enable = (bool)json_value_get_boolean(val);
+        if (whitelist_enable == true) {
+            MSG("INFO: whitelist is enabled\n");
+        } else {
+            MSG("INFO: whitelist is disabled\n");
+        }
+    } else {
+        MSG("INFO: whitelist is disabled\n");
+    }
+    
+    val = json_object_get_string(conf_obj, "whitelist_devaddr_min");
+    if (val != NULL) {
+        whitelist_devaddr_min = (uint32_t) strtoll(val, NULL, 16);
+        MSG("INFO: whitelist_devaddr_min set to 0x%x\n", whitelist_devaddr_min);
+    }
+
+    val = json_object_get_string(conf_obj, "whitelist_devaddr_max");
+    if (val != NULL) {
+        whitelist_devaddr_max = (uint32_t) strtoll(val, NULL, 16);
+        MSG("INFO: whitelist_devaddr_max set to 0x%x\n", whitelist_devaddr_max);
+    }
+
+    /* Whitelist Net IDs */
+    JSON_Array * conf_whitelist_netids_array = json_object_get_array(conf_obj, "whitelist_netids");
+    if (conf_whitelist_netids_array != NULL) {
+        whitelist_netids_count = json_array_get_count(conf_whitelist_netids_array);
+        if( whitelist_netids_count > WHITELIST_SIZE) {
+            whitelist_netids_count = WHITELIST_SIZE;
+        }
+        for (uint8_t i = 0; i < whitelist_netids_count; i++) {
+            str = json_array_get_string(conf_whitelist_netids_array, i);
+            if (str != NULL) {
+                whitelist_netids[i] = ((int) strtol(str, NULL, 16)) & 0x00FFFFFF;
+                MSG("INFO: whitelist NetID: 0x%06X\n", whitelist_netids[i]);
+            }
+        }
+    }
+
+    /* Whitelist OUIs */
+    JSON_Array * conf_whitelist_ouis_array = json_object_get_array(conf_obj, "whitelist_ouis");
+    if (conf_whitelist_ouis_array != NULL) {
+        whitelist_ouis_count = json_array_get_count(conf_whitelist_ouis_array);
+        if( whitelist_ouis_count > WHITELIST_SIZE) {
+            whitelist_ouis_count = WHITELIST_SIZE;
+        }
+        for (uint8_t i = 0; i < whitelist_ouis_count; i++) {
+            str = json_array_get_string(conf_whitelist_ouis_array, i);
+            if (str != NULL) {
+                whitelist_ouis[i] = ((int) strtol(str, NULL, 16)) & 0x00FFFFFF;
+                MSG("INFO: whitelist OUI: 0x%06X\n", whitelist_ouis[i]);
+            }
+        }
+    }
     /* free JSON parsing data structure */
     json_value_free(root_val);
     return 0;
@@ -1455,6 +1525,19 @@ static void lora_module_state(uint8_t state)
     system(info);
 }
 
+static uint32_t get_netid(uint32_t devaddr) {
+
+    uint8_t nwkid_bits_array[] = { 6, 6, 9, 11, 12, 13, 15, 17 };
+    uint8_t type_id = __builtin_clz(~devaddr);
+    if (type_id > 7) return 0;
+
+    uint8_t nwkid_bits = nwkid_bits_array[type_id];
+    uint32_t nwkid = devaddr >> (31 - type_id - nwkid_bits);
+    nwkid &= ((1 << nwkid_bits) - 1);
+
+    return (type_id << 21) | nwkid;
+}
+
 /* -------------------------------------------------------------------------- */
 /* --- MAIN FUNCTION -------------------------------------------------------- */
 
@@ -2113,20 +2196,11 @@ void thread_up(void) {
         for (i = 0; i < nb_pkt; ++i) {
             p = &rxpkt[i];
 
-            /* Get mote information from current packet (addr, fcnt) */
-            /* FHDR - DevAddr */
-            if (p->size >= 8) {
-                mote_addr  = p->payload[1];
-                mote_addr |= p->payload[2] << 8;
-                mote_addr |= p->payload[3] << 16;
-                mote_addr |= p->payload[4] << 24;
-                /* FHDR - FCnt */
-                mote_fcnt  = p->payload[6];
-                mote_fcnt |= p->payload[7] << 8;
-            } else {
-                mote_addr = 0;
-                mote_fcnt = 0;
+            printf("INFO: [up] payload (%d bytes): ", p->size);
+            for (uint8_t i=0; i<p->size; i++) {
+                printf("%02X", p->payload[i]);
             }
+            printf("\n");
 
             /* basic packet filtering */
             pthread_mutex_lock(&mx_meas_up);
@@ -2162,7 +2236,96 @@ void thread_up(void) {
             meas_up_pkt_fwd += 1;
             meas_up_payload_byte += p->size;
             pthread_mutex_unlock(&mx_meas_up);
-            printf( "\nINFO: Received pkt from mote: %08X (fcnt=%u)\n", mote_addr, mote_fcnt );
+
+
+            // printf( "\nINFO: Received pkt from mote: %08X (fcnt=%u)\n", mote_addr, mote_fcnt );
+            /* Type of message 
+            *   0: Join-Request
+            *   1: Join-Accept
+            *   2: Unconfirmed Data Uplink
+            *   3: Unconfirmed Data Downlink
+            *   4: Confirmed Data Uplink
+            *   5: Confirmed Data Downlink
+            *   6: Rejoin-request
+            *   7: Propietary
+            */
+            uint8_t fType = p->payload[0] >> 5;
+
+            /* Filter JOINs */
+            if (0 == fType) {
+                
+                uint32_t deveui_h = 0;
+                uint32_t deveui_l = 0;
+                deveui_l  = p->payload[ 9];
+                deveui_l |= p->payload[10] << 8;
+                deveui_l |= p->payload[11] << 16;
+                deveui_l |= p->payload[12] << 24;
+                deveui_h  = p->payload[13];
+                deveui_h |= p->payload[14] << 8;
+                deveui_h |= p->payload[15] << 16;
+                deveui_h |= p->payload[16] << 24;
+
+                printf("INFO: [up] Join-Request from %08X%08X\n", deveui_h, deveui_l);
+                uint32_t oui = deveui_h >> 8;
+                
+                bool found = true;
+                if( whitelist_enable ) {
+                    found = false;
+                    for (uint8_t i=0; i<whitelist_ouis_count; i++) {
+                        if (oui == whitelist_ouis[i]) {
+                            found = true;
+                            break;
+                        }
+                    }
+                } else {
+                    found = true;
+                }
+
+                if (!found) {
+                    printf("INFO: [up] OUI %06X not in the whitelist, filter out Join Request\n", oui);
+                    continue; /* skip that packet */
+                }
+
+            } else if (p->size >= 8) {
+
+                mote_addr  = p->payload[1];
+                mote_addr |= p->payload[2] << 8;
+                mote_addr |= p->payload[3] << 16;
+                mote_addr |= p->payload[4] << 24;
+                mote_fcnt  = p->payload[6];
+                mote_fcnt |= p->payload[7] << 8;
+
+                uint32_t netid = get_netid(mote_addr);
+                printf( "INFO: [up] pkt from mote: 0x%08X (netid=0x%06X, fcnt=%u)\n", mote_addr, netid, mote_fcnt );
+
+                bool found = true;
+                if( whitelist_enable ) {
+                    found = false;
+                    for (uint8_t i=0; i<whitelist_netids_count; i++) {
+                        if (netid == whitelist_netids[i]) {
+                            found = true;
+                            break;
+                        }
+                    }
+                    if (mote_addr >= whitelist_devaddr_min && mote_addr <= whitelist_devaddr_max) {
+                        found = true;
+                    }
+                } else {
+                    found = true;
+                }
+
+    
+                if (!found) {
+                    printf("INFO: [up] NetID %06X not in the whitelist, skipping packet\n", netid);
+                    continue; /* skip that packet */
+                }
+
+            } else {
+
+                mote_addr = 0;
+                mote_fcnt = 0;
+                
+            }
 
             /* Start of packet, add inter-packet separator if necessary */
             if (pkt_in_dgram == 0) {
-- 
2.43.0

